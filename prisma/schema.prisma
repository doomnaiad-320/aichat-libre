generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// NextAuth 账户
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// NextAuth 会话
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// 用户
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?   @db.VarChar(500)
  password      String?   // 本地认证
  role          UserRole  @default(USER)
  balance       Int       @default(0) // Token余额

  // Stripe相关
  stripeCustomerId     String?   @unique @db.VarChar(255)
  stripeSubscriptionId String?   @db.VarChar(255)
  stripePriceId        String?   @db.VarChar(255)
  plan                 PlanType  @default(FREE)
  planExpiresAt        DateTime?

  // 关联
  accounts     Account[]
  sessions     Session[]
  characters   Character[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([stripeCustomerId])
}

// 角色卡 (公开分享的)
model Character {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 核心字段 (便于搜索)
  name        String     @db.VarChar(255)
  description String?    @db.Text
  tags        Json?      // ["fantasy", "romance"]

  // 完整角色卡JSON
  cardData    Json

  // 社区
  visibility  Visibility @default(PRIVATE)
  likes       Int        @default(0)
  downloads   Int        @default(0)

  // 关联
  characterLikes CharacterLike[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([visibility, likes])
  @@index([name])
}

// 角色卡点赞记录
model CharacterLike {
  id          String    @id @default(cuid())
  userId      String
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@unique([userId, characterId])
  @@index([characterId])
  @@index([userId])
}

// AI服务商配置
model AIProvider {
  id        String   @id @default(cuid())
  name      String   @unique @db.VarChar(100)
  baseUrl   String?  @db.VarChar(500)
  apiKey    String   @db.Text // 加密存储
  models    Json     // 支持的模型列表
  enabled   Boolean  @default(true)

  // 价格配置 (每1K tokens)
  inputPrice  Decimal? @db.Decimal(10, 6)
  outputPrice Decimal? @db.Decimal(10, 6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 交易记录
model Transaction {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      TransactionType
  amount    Int             // Token数量 (正数为增加，负数为消费)
  balance   Int             // 交易后余额
  model     String?         @db.VarChar(100) // 使用的模型
  provider  String?         @db.VarChar(100) // AI服务商

  // Stripe相关
  stripePaymentId String?   @db.VarChar(255)
  description     String?   @db.VarChar(500)

  createdAt DateTime        @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([stripePaymentId])
}

// 枚举
enum UserRole {
  USER
  ADMIN
}

enum PlanType {
  FREE
  PRO
  PREMIUM
}

enum Visibility {
  PRIVATE
  PUBLIC
  UNLISTED
}

enum TransactionType {
  SPEND      // 消费
  REFUND     // 退款
  PURCHASE   // 购买Token
  SUBSCRIBE  // 订阅赠送
  GRANT      // 管理员赠送
}
